<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line"><span class="keyword">function</span> <span class="var type0" id="S16T0U87">q</span>  = runMadwickUpdate(<span class="var type1" id="S17T4U90">qIn</span>,<span class="var type1" id="S18T11U91">Accelerometer</span>,<span class="var type1" id="S19T11U92">Gyroscope</span>,<span class="var type1" id="S20T11U93">Magnetometer</span>,<span class="var type1" id="S21T3U94">Beta</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line"><span class="mxinfo " id="T4:U6"><span class="var type1" id="S16T4U97">q</span>=<span class="var type1" id="S17T4U98">qIn</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line"><span class="mxinfo " id="T3:U9"><span class="var type1" id="S22T3U101">SamplePeriod</span>=<span class="mxinfo " id="T3:U11">single(<span class="mxinfo " id="T8:U12"><span class="mxinfo " id="T8:U13">5</span>/<span class="mxinfo " id="T8:U14">1000</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line"><span class="comment">% Normalise accelerometer measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T5:U15">~<span class="mxinfo " id="T5:U16">all(<span class="mxinfo " id="T41:U17"><span class="mxinfo " id="T11:U18">abs(<span class="var type1" id="S18T11U115">Accelerometer</span>)</span>&lt;<span class="mxinfo " id="T8:U20">.0001</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line">    <span class="mxinfo " id="T11:U21"><span class="var type1" id="S18T11U119">Accelerometer</span> = <span class="mxinfo " id="T11:U23"><span class="var type1" id="S18T11U121">Accelerometer</span> / <span class="mxinfo " id="T3:U25">norm(<span class="var type1" id="S18T11U124">Accelerometer</span>)</span></span></span>;    <span class="comment">% normalise magnitude</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line"><span class="comment">% Normalise magnetometer measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T5:U27">~<span class="mxinfo " id="T5:U28">all(<span class="mxinfo " id="T41:U29"><span class="mxinfo " id="T11:U30">abs(<span class="var type1" id="S20T11U133">Magnetometer</span>)</span>&lt;<span class="mxinfo " id="T8:U32">.0001</span></span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line">    <span class="mxinfo " id="T11:U33"><span class="var type1" id="S20T11U137">Magnetometer</span> = <span class="mxinfo " id="T11:U35"><span class="var type1" id="S20T11U139">Magnetometer</span> / <span class="mxinfo " id="T3:U37">norm(<span class="var type1" id="S20T11U142">Magnetometer</span>)</span></span></span>;   <span class="comment">% normalise magnitude</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">32</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">33</a></span><span class="line"><span class="comment">% Reference direction of Earth's magnetic feild</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">34</a></span><span class="line"><span class="mxinfo " id="T6:U39"><span class="var type1" id="S27T6U145">h</span> = <span class="mxinfo " id="T6:U41"><span class="fcn" id="F229N6:B147">quaternProd</span>(<span class="var type1" id="S16T4U148">q</span>, <span class="mxinfo " id="T6:U43"><span class="fcn" id="F228N6:B150">quaternProd</span>(<span class="mxinfo " id="T42:U44">[<span class="mxinfo " id="T3:U45">0</span> <span class="mxinfo " id="T43:U46"><span class="var type1" id="S20T11U155">Magnetometer</span>'</span>]</span>, <span class="mxinfo " id="T4:U48"><span class="fcn" id="F227N5:B157">quaternConj</span>(<span class="var type1" id="S16T4U158">q</span>)</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35">35</a></span><span class="line"><span class="mxinfo " id="T7:U50"><span class="var type1" id="S30T7U161">b</span> = <span class="mxinfo " id="T7:U52">[<span class="mxinfo " id="T8:U53">0</span> <span class="mxinfo " id="T8:U54">norm(<span class="mxinfo " id="T16:U55">[<span class="mxinfo " id="T8:U56"><span class="var type1" id="S27T6U170">h</span>(<span class="mxinfo " id="T17:U58">2</span>)</span> <span class="mxinfo " id="T8:U59"><span class="var type1" id="S27T6U173">h</span>(<span class="mxinfo " id="T17:U61">3</span>)</span>]</span>)</span> <span class="mxinfo " id="T8:U62">0</span> <span class="mxinfo " id="T8:U63"><span class="var type1" id="S27T6U177">h</span>(<span class="mxinfo " id="T17:U65">4</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36">36</a></span><span class="line"><span class="comment">% Gradient decent algorithm corrective step</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37">37</a></span><span class="line"><span class="mxinfo " id="T44:U66"><span class="var type1" id="S31T44U181">F</span> = <span class="mxinfo " id="T44:U68">[<span class="mxinfo " id="T3:U69"><span class="mxinfo " id="T3:U70">2*(<span class="mxinfo " id="T3:U71"><span class="mxinfo " id="T3:U72"><span class="mxinfo " id="T3:U73"><span class="var type1" id="S16T4U191">q</span>(<span class="mxinfo " id="T17:U75">2</span>)</span>*<span class="mxinfo " id="T3:U76"><span class="var type1" id="S16T4U194">q</span>(<span class="mxinfo " id="T8:U78">4</span>)</span></span> - <span class="mxinfo " id="T3:U79"><span class="mxinfo " id="T3:U80"><span class="var type1" id="S16T4U198">q</span>(<span class="mxinfo " id="T8:U82">1</span>)</span>*<span class="mxinfo " id="T3:U83"><span class="var type1" id="S16T4U201">q</span>(<span class="mxinfo " id="T8:U85">3</span>)</span></span></span>)</span> - <span class="mxinfo " id="T3:U86"><span class="var type1" id="S18T11U204">Accelerometer</span>(<span class="mxinfo " id="T8:U88">1</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38">38</a></span><span class="line">    <span class="mxinfo " id="T3:U89"><span class="mxinfo " id="T3:U90">2*(<span class="mxinfo " id="T3:U91"><span class="mxinfo " id="T3:U92"><span class="mxinfo " id="T3:U93"><span class="var type1" id="S16T4U214">q</span>(<span class="mxinfo " id="T17:U95">1</span>)</span>*<span class="mxinfo " id="T3:U96"><span class="var type1" id="S16T4U217">q</span>(<span class="mxinfo " id="T8:U98">2</span>)</span></span> + <span class="mxinfo " id="T3:U99"><span class="mxinfo " id="T3:U100"><span class="var type1" id="S16T4U221">q</span>(<span class="mxinfo " id="T8:U102">3</span>)</span>*<span class="mxinfo " id="T3:U103"><span class="var type1" id="S16T4U224">q</span>(<span class="mxinfo " id="T8:U105">4</span>)</span></span></span>)</span> - <span class="mxinfo " id="T3:U106"><span class="var type1" id="S18T11U227">Accelerometer</span>(<span class="mxinfo " id="T8:U108">2</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39">39</a></span><span class="line">    <span class="mxinfo " id="T3:U109"><span class="mxinfo " id="T3:U110">2*(<span class="mxinfo " id="T3:U111"><span class="mxinfo " id="T3:U112"><span class="mxinfo " id="T8:U113">0.5</span> - <span class="mxinfo " id="T3:U114"><span class="mxinfo " id="T3:U115"><span class="var type1" id="S16T4U239">q</span>(<span class="mxinfo " id="T17:U117">2</span>)</span>^2</span></span> - <span class="mxinfo " id="T3:U118"><span class="mxinfo " id="T3:U119"><span class="var type1" id="S16T4U244">q</span>(<span class="mxinfo " id="T17:U121">3</span>)</span>^2</span></span>)</span> - <span class="mxinfo " id="T3:U122"><span class="var type1" id="S18T11U248">Accelerometer</span>(<span class="mxinfo " id="T8:U124">3</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40">40</a></span><span class="line">    <span class="mxinfo " id="T3:U125"><span class="mxinfo " id="T3:U126"><span class="mxinfo " id="T3:U127"><span class="mxinfo " id="T8:U128"><span class="mxinfo " id="T8:U129">2</span>*<span class="mxinfo " id="T8:U130"><span class="var type1" id="S30T7U257">b</span>(<span class="mxinfo " id="T17:U132">2</span>)</span></span>*(<span class="mxinfo " id="T3:U133"><span class="mxinfo " id="T3:U134"><span class="mxinfo " id="T8:U135">0.5</span> - <span class="mxinfo " id="T3:U136"><span class="mxinfo " id="T3:U137"><span class="var type1" id="S16T4U265">q</span>(<span class="mxinfo " id="T17:U139">3</span>)</span>^2</span></span> - <span class="mxinfo " id="T3:U140"><span class="mxinfo " id="T3:U141"><span class="var type1" id="S16T4U270">q</span>(<span class="mxinfo " id="T17:U143">4</span>)</span>^2</span></span>)</span> + <span class="mxinfo " id="T3:U144"><span class="mxinfo " id="T8:U145"><span class="mxinfo " id="T8:U146">2</span>*<span class="mxinfo " id="T8:U147"><span class="var type1" id="S30T7U277">b</span>(<span class="mxinfo " id="T17:U149">4</span>)</span></span>*(<span class="mxinfo " id="T3:U150"><span class="mxinfo " id="T3:U151"><span class="mxinfo " id="T3:U152"><span class="var type1" id="S16T4U283">q</span>(<span class="mxinfo " id="T17:U154">2</span>)</span>*<span class="mxinfo " id="T3:U155"><span class="var type1" id="S16T4U286">q</span>(<span class="mxinfo " id="T8:U157">4</span>)</span></span> - <span class="mxinfo " id="T3:U158"><span class="mxinfo " id="T3:U159"><span class="var type1" id="S16T4U290">q</span>(<span class="mxinfo " id="T8:U161">1</span>)</span>*<span class="mxinfo " id="T3:U162"><span class="var type1" id="S16T4U293">q</span>(<span class="mxinfo " id="T8:U164">3</span>)</span></span></span>)</span></span> - <span class="mxinfo " id="T3:U165"><span class="var type1" id="S20T11U296">Magnetometer</span>(<span class="mxinfo " id="T8:U167">1</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41">41</a></span><span class="line">    <span class="mxinfo " id="T3:U168"><span class="mxinfo " id="T3:U169"><span class="mxinfo " id="T3:U170"><span class="mxinfo " id="T8:U171"><span class="mxinfo " id="T8:U172">2</span>*<span class="mxinfo " id="T8:U173"><span class="var type1" id="S30T7U305">b</span>(<span class="mxinfo " id="T17:U175">2</span>)</span></span>*(<span class="mxinfo " id="T3:U176"><span class="mxinfo " id="T3:U177"><span class="mxinfo " id="T3:U178"><span class="var type1" id="S16T4U311">q</span>(<span class="mxinfo " id="T17:U180">2</span>)</span>*<span class="mxinfo " id="T3:U181"><span class="var type1" id="S16T4U314">q</span>(<span class="mxinfo " id="T8:U183">3</span>)</span></span> - <span class="mxinfo " id="T3:U184"><span class="mxinfo " id="T3:U185"><span class="var type1" id="S16T4U318">q</span>(<span class="mxinfo " id="T8:U187">1</span>)</span>*<span class="mxinfo " id="T3:U188"><span class="var type1" id="S16T4U321">q</span>(<span class="mxinfo " id="T8:U190">4</span>)</span></span></span>)</span> + <span class="mxinfo " id="T3:U191"><span class="mxinfo " id="T8:U192"><span class="mxinfo " id="T8:U193">2</span>*<span class="mxinfo " id="T8:U194"><span class="var type1" id="S30T7U327">b</span>(<span class="mxinfo " id="T17:U196">4</span>)</span></span>*(<span class="mxinfo " id="T3:U197"><span class="mxinfo " id="T3:U198"><span class="mxinfo " id="T3:U199"><span class="var type1" id="S16T4U333">q</span>(<span class="mxinfo " id="T17:U201">1</span>)</span>*<span class="mxinfo " id="T3:U202"><span class="var type1" id="S16T4U336">q</span>(<span class="mxinfo " id="T8:U204">2</span>)</span></span> + <span class="mxinfo " id="T3:U205"><span class="mxinfo " id="T3:U206"><span class="var type1" id="S16T4U340">q</span>(<span class="mxinfo " id="T8:U208">3</span>)</span>*<span class="mxinfo " id="T3:U209"><span class="var type1" id="S16T4U343">q</span>(<span class="mxinfo " id="T8:U211">4</span>)</span></span></span>)</span></span> - <span class="mxinfo " id="T3:U212"><span class="var type1" id="S20T11U346">Magnetometer</span>(<span class="mxinfo " id="T8:U214">2</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42">42</a></span><span class="line">    <span class="mxinfo " id="T3:U215"><span class="mxinfo " id="T3:U216"><span class="mxinfo " id="T3:U217"><span class="mxinfo " id="T8:U218"><span class="mxinfo " id="T8:U219">2</span>*<span class="mxinfo " id="T8:U220"><span class="var type1" id="S30T7U355">b</span>(<span class="mxinfo " id="T17:U222">2</span>)</span></span>*(<span class="mxinfo " id="T3:U223"><span class="mxinfo " id="T3:U224"><span class="mxinfo " id="T3:U225"><span class="var type1" id="S16T4U361">q</span>(<span class="mxinfo " id="T17:U227">1</span>)</span>*<span class="mxinfo " id="T3:U228"><span class="var type1" id="S16T4U364">q</span>(<span class="mxinfo " id="T8:U230">3</span>)</span></span> + <span class="mxinfo " id="T3:U231"><span class="mxinfo " id="T3:U232"><span class="var type1" id="S16T4U368">q</span>(<span class="mxinfo " id="T8:U234">2</span>)</span>*<span class="mxinfo " id="T3:U235"><span class="var type1" id="S16T4U371">q</span>(<span class="mxinfo " id="T8:U237">4</span>)</span></span></span>)</span> + <span class="mxinfo " id="T3:U238"><span class="mxinfo " id="T8:U239"><span class="mxinfo " id="T8:U240">2</span>*<span class="mxinfo " id="T8:U241"><span class="var type1" id="S30T7U377">b</span>(<span class="mxinfo " id="T17:U243">4</span>)</span></span>*(<span class="mxinfo " id="T3:U244"><span class="mxinfo " id="T3:U245"><span class="mxinfo " id="T8:U246">0.5</span> - <span class="mxinfo " id="T3:U247"><span class="mxinfo " id="T3:U248"><span class="var type1" id="S16T4U385">q</span>(<span class="mxinfo " id="T17:U250">2</span>)</span>^2</span></span> - <span class="mxinfo " id="T3:U251"><span class="mxinfo " id="T3:U252"><span class="var type1" id="S16T4U390">q</span>(<span class="mxinfo " id="T17:U254">3</span>)</span>^2</span></span>)</span></span> - <span class="mxinfo " id="T3:U255"><span class="var type1" id="S20T11U394">Magnetometer</span>(<span class="mxinfo " id="T8:U257">3</span>)</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43">43</a></span><span class="line"><span class="mxinfo " id="T45:U258"><span class="var type1" id="S32T45U398">J</span> = <span class="mxinfo " id="T45:U260">[<span class="mxinfo " id="T42:U261"><span class="mxinfo " id="T3:U262">-2*<span class="mxinfo " id="T3:U263"><span class="var type1" id="S16T4U405">q</span>(<span class="mxinfo " id="T17:U265">3</span>)</span></span>,                   <span class="mxinfo " id="T3:U266">2*<span class="mxinfo " id="T3:U267"><span class="var type1" id="S16T4U410">q</span>(<span class="mxinfo " id="T17:U269">4</span>)</span></span>,                    <span class="mxinfo " id="T3:U270">-2*<span class="mxinfo " id="T3:U271"><span class="var type1" id="S16T4U416">q</span>(<span class="mxinfo " id="T17:U273">1</span>)</span></span>,                         <span class="mxinfo " id="T3:U274">2*<span class="mxinfo " id="T3:U275"><span class="var type1" id="S16T4U421">q</span>(<span class="mxinfo " id="T17:U277">2</span>)</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44">44</a></span><span class="line">    <span class="mxinfo " id="T42:U278"><span class="mxinfo " id="T3:U279">2*<span class="mxinfo " id="T3:U280"><span class="var type1" id="S16T4U427">q</span>(<span class="mxinfo " id="T17:U282">2</span>)</span></span>,                     <span class="mxinfo " id="T3:U283">2*<span class="mxinfo " id="T3:U284"><span class="var type1" id="S16T4U432">q</span>(<span class="mxinfo " id="T17:U286">1</span>)</span></span>,                     <span class="mxinfo " id="T3:U287">2*<span class="mxinfo " id="T3:U288"><span class="var type1" id="S16T4U437">q</span>(<span class="mxinfo " id="T17:U290">4</span>)</span></span>,                         <span class="mxinfo " id="T3:U291">2*<span class="mxinfo " id="T3:U292"><span class="var type1" id="S16T4U442">q</span>(<span class="mxinfo " id="T17:U294">3</span>)</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45">45</a></span><span class="line">    <span class="mxinfo " id="T42:U295"><span class="mxinfo " id="T3:U296">0</span>,                         <span class="mxinfo " id="T3:U297">-4*<span class="mxinfo " id="T3:U298"><span class="var type1" id="S16T4U450">q</span>(<span class="mxinfo " id="T17:U300">2</span>)</span></span>,                    <span class="mxinfo " id="T3:U301">-4*<span class="mxinfo " id="T3:U302"><span class="var type1" id="S16T4U456">q</span>(<span class="mxinfo " id="T17:U304">3</span>)</span></span>,                         <span class="mxinfo " id="T3:U305">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46">46</a></span><span class="line">    <span class="mxinfo " id="T42:U306"><span class="mxinfo " id="T3:U307"><span class="mxinfo " id="T8:U308"><span class="mxinfo " id="T8:U309">-<span class="mxinfo " id="T8:U310">2</span></span>*<span class="mxinfo " id="T8:U311"><span class="var type1" id="S30T7U465">b</span>(<span class="mxinfo " id="T17:U313">4</span>)</span></span>*<span class="mxinfo " id="T3:U314"><span class="var type1" id="S16T4U468">q</span>(<span class="mxinfo " id="T17:U316">3</span>)</span></span>,               <span class="mxinfo " id="T3:U317"><span class="mxinfo " id="T8:U318"><span class="mxinfo " id="T8:U319">2</span>*<span class="mxinfo " id="T8:U320"><span class="var type1" id="S30T7U474">b</span>(<span class="mxinfo " id="T17:U322">4</span>)</span></span>*<span class="mxinfo " id="T3:U323"><span class="var type1" id="S16T4U477">q</span>(<span class="mxinfo " id="T17:U325">4</span>)</span></span>,               <span class="mxinfo " id="T3:U326"><span class="mxinfo " id="T3:U327"><span class="mxinfo " id="T8:U328"><span class="mxinfo " id="T8:U329">-<span class="mxinfo " id="T8:U330">4</span></span>*<span class="mxinfo " id="T8:U331"><span class="var type1" id="S30T7U485">b</span>(<span class="mxinfo " id="T17:U333">2</span>)</span></span>*<span class="mxinfo " id="T3:U334"><span class="var type1" id="S16T4U488">q</span>(<span class="mxinfo " id="T17:U336">3</span>)</span></span>-<span class="mxinfo " id="T3:U337"><span class="mxinfo " id="T8:U338"><span class="mxinfo " id="T8:U339">2</span>*<span class="mxinfo " id="T8:U340"><span class="var type1" id="S30T7U494">b</span>(<span class="mxinfo " id="T17:U342">4</span>)</span></span>*<span class="mxinfo " id="T3:U343"><span class="var type1" id="S16T4U497">q</span>(<span class="mxinfo " id="T17:U345">1</span>)</span></span></span>,       <span class="mxinfo " id="T3:U346"><span class="mxinfo " id="T3:U347"><span class="mxinfo " id="T8:U348"><span class="mxinfo " id="T8:U349">-<span class="mxinfo " id="T8:U350">4</span></span>*<span class="mxinfo " id="T8:U351"><span class="var type1" id="S30T7U505">b</span>(<span class="mxinfo " id="T17:U353">2</span>)</span></span>*<span class="mxinfo " id="T3:U354"><span class="var type1" id="S16T4U508">q</span>(<span class="mxinfo " id="T17:U356">4</span>)</span></span>+<span class="mxinfo " id="T3:U357"><span class="mxinfo " id="T8:U358"><span class="mxinfo " id="T8:U359">2</span>*<span class="mxinfo " id="T8:U360"><span class="var type1" id="S30T7U514">b</span>(<span class="mxinfo " id="T17:U362">4</span>)</span></span>*<span class="mxinfo " id="T3:U363"><span class="var type1" id="S16T4U517">q</span>(<span class="mxinfo " id="T17:U365">2</span>)</span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47">47</a></span><span class="line">    <span class="mxinfo " id="T42:U366"><span class="mxinfo " id="T3:U367"><span class="mxinfo " id="T3:U368"><span class="mxinfo " id="T8:U369"><span class="mxinfo " id="T8:U370">-<span class="mxinfo " id="T8:U371">2</span></span>*<span class="mxinfo " id="T8:U372"><span class="var type1" id="S30T7U526">b</span>(<span class="mxinfo " id="T17:U374">2</span>)</span></span>*<span class="mxinfo " id="T3:U375"><span class="var type1" id="S16T4U529">q</span>(<span class="mxinfo " id="T17:U377">4</span>)</span></span>+<span class="mxinfo " id="T3:U378"><span class="mxinfo " id="T8:U379"><span class="mxinfo " id="T8:U380">2</span>*<span class="mxinfo " id="T8:U381"><span class="var type1" id="S30T7U535">b</span>(<span class="mxinfo " id="T17:U383">4</span>)</span></span>*<span class="mxinfo " id="T3:U384"><span class="var type1" id="S16T4U538">q</span>(<span class="mxinfo " id="T17:U386">2</span>)</span></span></span>,   <span class="mxinfo " id="T3:U387"><span class="mxinfo " id="T3:U388"><span class="mxinfo " id="T8:U389"><span class="mxinfo " id="T8:U390">2</span>*<span class="mxinfo " id="T8:U391"><span class="var type1" id="S30T7U545">b</span>(<span class="mxinfo " id="T17:U393">2</span>)</span></span>*<span class="mxinfo " id="T3:U394"><span class="var type1" id="S16T4U548">q</span>(<span class="mxinfo " id="T17:U396">3</span>)</span></span>+<span class="mxinfo " id="T3:U397"><span class="mxinfo " id="T8:U398"><span class="mxinfo " id="T8:U399">2</span>*<span class="mxinfo " id="T8:U400"><span class="var type1" id="S30T7U554">b</span>(<span class="mxinfo " id="T17:U402">4</span>)</span></span>*<span class="mxinfo " id="T3:U403"><span class="var type1" id="S16T4U557">q</span>(<span class="mxinfo " id="T17:U405">1</span>)</span></span></span>,    <span class="mxinfo " id="T3:U406"><span class="mxinfo " id="T3:U407"><span class="mxinfo " id="T8:U408"><span class="mxinfo " id="T8:U409">2</span>*<span class="mxinfo " id="T8:U410"><span class="var type1" id="S30T7U564">b</span>(<span class="mxinfo " id="T17:U412">2</span>)</span></span>*<span class="mxinfo " id="T3:U413"><span class="var type1" id="S16T4U567">q</span>(<span class="mxinfo " id="T17:U415">2</span>)</span></span>+<span class="mxinfo " id="T3:U416"><span class="mxinfo " id="T8:U417"><span class="mxinfo " id="T8:U418">2</span>*<span class="mxinfo " id="T8:U419"><span class="var type1" id="S30T7U573">b</span>(<span class="mxinfo " id="T17:U421">4</span>)</span></span>*<span class="mxinfo " id="T3:U422"><span class="var type1" id="S16T4U576">q</span>(<span class="mxinfo " id="T17:U424">4</span>)</span></span></span>,       <span class="mxinfo " id="T3:U425"><span class="mxinfo " id="T3:U426"><span class="mxinfo " id="T8:U427"><span class="mxinfo " id="T8:U428">-<span class="mxinfo " id="T8:U429">2</span></span>*<span class="mxinfo " id="T8:U430"><span class="var type1" id="S30T7U584">b</span>(<span class="mxinfo " id="T17:U432">2</span>)</span></span>*<span class="mxinfo " id="T3:U433"><span class="var type1" id="S16T4U587">q</span>(<span class="mxinfo " id="T17:U435">1</span>)</span></span>+<span class="mxinfo " id="T3:U436"><span class="mxinfo " id="T8:U437"><span class="mxinfo " id="T8:U438">2</span>*<span class="mxinfo " id="T8:U439"><span class="var type1" id="S30T7U593">b</span>(<span class="mxinfo " id="T17:U441">4</span>)</span></span>*<span class="mxinfo " id="T3:U442"><span class="var type1" id="S16T4U596">q</span>(<span class="mxinfo " id="T17:U444">3</span>)</span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48">48</a></span><span class="line">    <span class="mxinfo " id="T42:U445"><span class="mxinfo " id="T3:U446"><span class="mxinfo " id="T8:U447"><span class="mxinfo " id="T8:U448">2</span>*<span class="mxinfo " id="T8:U449"><span class="var type1" id="S30T7U603">b</span>(<span class="mxinfo " id="T17:U451">2</span>)</span></span>*<span class="mxinfo " id="T3:U452"><span class="var type1" id="S16T4U606">q</span>(<span class="mxinfo " id="T17:U454">3</span>)</span></span>,                <span class="mxinfo " id="T3:U455"><span class="mxinfo " id="T3:U456"><span class="mxinfo " id="T8:U457"><span class="mxinfo " id="T8:U458">2</span>*<span class="mxinfo " id="T8:U459"><span class="var type1" id="S30T7U613">b</span>(<span class="mxinfo " id="T17:U461">2</span>)</span></span>*<span class="mxinfo " id="T3:U462"><span class="var type1" id="S16T4U616">q</span>(<span class="mxinfo " id="T17:U464">4</span>)</span></span>-<span class="mxinfo " id="T3:U465"><span class="mxinfo " id="T8:U466"><span class="mxinfo " id="T8:U467">4</span>*<span class="mxinfo " id="T8:U468"><span class="var type1" id="S30T7U622">b</span>(<span class="mxinfo " id="T17:U470">4</span>)</span></span>*<span class="mxinfo " id="T3:U471"><span class="var type1" id="S16T4U625">q</span>(<span class="mxinfo " id="T17:U473">2</span>)</span></span></span>,    <span class="mxinfo " id="T3:U474"><span class="mxinfo " id="T3:U475"><span class="mxinfo " id="T8:U476"><span class="mxinfo " id="T8:U477">2</span>*<span class="mxinfo " id="T8:U478"><span class="var type1" id="S30T7U632">b</span>(<span class="mxinfo " id="T17:U480">2</span>)</span></span>*<span class="mxinfo " id="T3:U481"><span class="var type1" id="S16T4U635">q</span>(<span class="mxinfo " id="T17:U483">1</span>)</span></span>-<span class="mxinfo " id="T3:U484"><span class="mxinfo " id="T8:U485"><span class="mxinfo " id="T8:U486">4</span>*<span class="mxinfo " id="T8:U487"><span class="var type1" id="S30T7U641">b</span>(<span class="mxinfo " id="T17:U489">4</span>)</span></span>*<span class="mxinfo " id="T3:U490"><span class="var type1" id="S16T4U644">q</span>(<span class="mxinfo " id="T17:U492">3</span>)</span></span></span>,        <span class="mxinfo " id="T3:U493"><span class="mxinfo " id="T8:U494"><span class="mxinfo " id="T8:U495">2</span>*<span class="mxinfo " id="T8:U496"><span class="var type1" id="S30T7U650">b</span>(<span class="mxinfo " id="T17:U498">2</span>)</span></span>*<span class="mxinfo " id="T3:U499"><span class="var type1" id="S16T4U653">q</span>(<span class="mxinfo " id="T17:U501">2</span>)</span></span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49">49</a></span><span class="line"><span class="mxinfo " id="T4:U502"><span class="var type1" id="S33T4U657">step</span> = (<span class="mxinfo " id="T4:U504"><span class="mxinfo " id="T46:U505"><span class="var type1" id="S32T45U661">J</span>'</span>*<span class="var type1" id="S31T44U662">F</span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50">50</a></span><span class="line"><span class="mxinfo " id="T4:U508"><span class="var type1" id="S33T4U665">step</span> = <span class="mxinfo " id="T4:U510"><span class="var type1" id="S33T4U667">step</span> / <span class="mxinfo " id="T3:U512">norm(<span class="var type1" id="S33T4U670">step</span>)</span></span></span>;   <span class="comment">% normalise step magnitude</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51">51</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52">52</a></span><span class="line"><span class="comment">% Compute rate of change of quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53">53</a></span><span class="line"><span class="var type0" id="S34T0U673">qDot</span> = <span class="message error" id="M4F192C"><span class="mxinfo " id="T6:U514"><span class="mxinfo " id="T8:U515">0.5</span> * <span class="mxinfo " id="T6:U516"><span class="fcn" id="F296N6:B678">quaternProd</span>(<span class="var type1" id="S16T4U679">q</span>, <span class="mxinfo " id="T4:U518">[<span class="mxinfo " id="T3:U519">0</span>; <span class="mxinfo " id="T3:U520"><span class="var type1" id="S19T11U685">Gyroscope</span>(<span class="mxinfo " id="T17:U522">1</span>)</span>; <span class="mxinfo " id="T3:U523"><span class="var type1" id="S19T11U689">Gyroscope</span>(<span class="mxinfo " id="T17:U525">2</span>)</span>; <span class="mxinfo " id="T3:U526"><span class="var type1" id="S19T11U693">Gyroscope</span>(<span class="mxinfo " id="T17:U528">3</span>)</span>]</span>)</span></span> - <span class="mxinfo " id="T42:U529"><span class="var type1" id="S21T3U696">Beta</span> * <span class="mxinfo " id="T42:U531"><span class="var type1" id="S33T4U698">step</span>'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54">54</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55">55</a></span><span class="line"><span class="comment">% Integrate to yield quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56">56</a></span><span class="line"><span class="var type0" id="S16T0U701">q</span> = <span class="var type1" id="S16T4U703">q</span> + <span class="var type0" id="S34T0U705"><span class="message error" id="M5F192C">qDot</span></span> * <span class="var type0" id="S22T0U706">SamplePeriod</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57">57</a></span><span class="line"><span class="var type0" id="S16T0U709">q</span> = <span class="var type0" id="S16T0U711"><span class="message error" id="M6F192C">q</span></span> / norm(<span class="var type0" id="S16T0U714">q</span>); <span class="comment">% normalise quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58">58</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59">59</a></span><span class="line"></span></span>
</pre>
